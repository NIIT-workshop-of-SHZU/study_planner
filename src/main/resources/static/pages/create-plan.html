<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>创建学习计划 - 智能学习计划生成器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-book"></i> 智能学习计划生成器
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">仪表盘</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="create-plan.html">创建计划</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="my-plans.html">我的计划</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ai-assistant.html">AI助手</a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="userNav"></ul>
            </div>
        </div>
    </nav>

    <main class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <!-- 登录状态提示 -->
                <div id="loginStatusAlert" class="alert alert-info mb-4" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    <span id="loginStatusText"></span>
                </div>

                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-magic"></i> 创建学习计划</h5>
                    </div>
                    <div class="card-body p-4">
                        <form id="createPlanForm">
                            <!-- 学习目标 -->
                            <div class="mb-4">
                                <label for="goal" class="form-label fw-bold">
                                    <i class="bi bi-bullseye text-primary"></i> 学习目标
                                </label>
                                <textarea class="form-control" id="goal" rows="3" required 
                                    placeholder="例如：学习Python编程，掌握基础语法、数据结构和常用库，能够独立完成小项目"></textarea>
                                <div class="form-text">详细描述你想学习的内容和期望达到的水平</div>
                            </div>
                            
                            <!-- 基础水平 -->
                            <div class="mb-4">
                                <label for="level" class="form-label fw-bold">
                                    <i class="bi bi-bar-chart text-success"></i> 当前基础
                                </label>
                                <select class="form-select" id="level" required>
                                    <option value="零基础">零基础 - 完全没接触过</option>
                                    <option value="初级">初级 - 了解基本概念</option>
                                    <option value="中级">中级 - 有一定实践经验</option>
                                    <option value="高级">高级 - 希望深入提升</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <!-- 每日学习时间 -->
                                <div class="col-md-6 mb-4">
                                    <label for="dailyHours" class="form-label fw-bold">
                                        <i class="bi bi-clock text-warning"></i> 每日学习时间
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="dailyHours" 
                                            value="2" min="0.5" max="12" step="0.5" required>
                                        <span class="input-group-text">小时</span>
                                    </div>
                                </div>
                                
                                <!-- 计划天数 -->
                                <div class="col-md-6 mb-4">
                                    <label for="totalDays" class="form-label fw-bold">
                                        <i class="bi bi-calendar3 text-info"></i> 计划天数
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="totalDays" 
                                            value="30" min="1" max="365" required>
                                        <span class="input-group-text">天</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 计划标题（可选） -->
                            <div class="mb-4">
                                <label for="title" class="form-label fw-bold">
                                    <i class="bi bi-card-heading text-secondary"></i> 计划标题（可选）
                                </label>
                                <input type="text" class="form-control" id="title" 
                                    placeholder="不填则由AI自动生成">
                            </div>

                            <!-- 模型选择区域 -->
                            <div class="card mb-4 border-primary">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-cpu"></i> AI模型配置</h6>
                                </div>
                                <div class="card-body">
                                    <!-- 登录用户：选择模型 -->
                                    <div id="loggedInConfig">
                                        <div class="mb-3">
                                            <label for="modelSelect" class="form-label">选择AI模型</label>
                                            <select class="form-select" id="modelSelect">
                                                <option value="">加载中...</option>
                                            </select>
                                            <div class="form-text text-success">
                                                <i class="bi bi-check-circle"></i> 已登录，使用系统提供的API服务
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 游客：自定义API配置 -->
                                    <div id="guestConfig" style="display: none;">
                                        <div class="alert alert-warning mb-3">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            游客模式：请配置您自己的API，生成的计划仅供预览不会保存
                                        </div>
                                        <div class="mb-3">
                                            <label for="customApiUrl" class="form-label">API URL <span class="text-danger">*</span></label>
                                            <input type="url" class="form-control" id="customApiUrl" 
                                                placeholder="例如：https://api.openai.com/v1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="customApiKey" class="form-label">API Key <span class="text-danger">*</span></label>
                                            <input type="password" class="form-control" id="customApiKey" 
                                                placeholder="输入您的API Key">
                                        </div>
                                        <div class="mb-3">
                                            <label for="customModel" class="form-label">模型名称 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="customModel" 
                                                placeholder="例如：gpt-3.5-turbo 或 deepseek-chat">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 提交按钮 -->
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="generateBtn">
                                    <i class="bi bi-robot"></i> AI生成学习计划
                                </button>
                            </div>
                        </form>
                        
                        <!-- 生成结果区域 -->
                        <div id="resultArea" class="mt-4" style="display: none;">
                            <hr>
                            <h5><i class="bi bi-check-circle text-success"></i> 计划生成成功！</h5>
                            <div id="planPreview"></div>
                            <div class="d-grid gap-2 mt-3" id="resultActions">
                                <a href="my-plans.html" class="btn btn-success">
                                    <i class="bi bi-list-check"></i> 查看我的计划
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 提示卡片 -->
                <div class="card mt-4 border-info">
                    <div class="card-body">
                        <h6 class="card-title text-info"><i class="bi bi-lightbulb"></i> 小提示</h6>
                        <ul class="mb-0 small text-muted">
                            <li>目标描述越详细，生成的计划越精准</li>
                            <li>建议每天学习时间2-4小时，保持可持续性</li>
                            <li><strong>登录用户</strong>：可直接使用系统提供的AI服务，计划会自动保存</li>
                            <li><strong>游客用户</strong>：需要配置自己的API，计划仅供预览</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/common.js"></script>
    <script>
        let availableModels = [];
        
        // 页面加载时检查登录状态和获取模型列表
        document.addEventListener('DOMContentLoaded', async () => {
            // 使用统一的登录状态检查
            await initLoginStatus();
            await loadModels();
            onLoginStatusReady();
        });
        
        // 监听登录状态变化
        window.addEventListener('loginStatusChanged', function(e) {
            onLoginStatusReady();
        });
        
        async function loadModels() {
            try {
                const result = await apiRequest('/plan/models');
                
                if (result && result.code === 200) {
                    availableModels = result.data.models || [];
                    const defaultModel = result.data.defaultModel;
                    
                    // 填充模型选择
                    const modelSelect = document.getElementById('modelSelect');
                    modelSelect.innerHTML = '';
                    availableModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === defaultModel) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('获取模型列表失败:', error);
            }
        }
        
        function onLoginStatusReady() {
            const loginStatusAlert = document.getElementById('loginStatusAlert');
            const loginStatusText = document.getElementById('loginStatusText');
            const loggedInConfig = document.getElementById('loggedInConfig');
            const guestConfig = document.getElementById('guestConfig');
            
            if (isLoggedIn()) {
                // 已登录
                loginStatusAlert.className = 'alert alert-success mb-4';
                loginStatusText.innerHTML = '<strong>已登录</strong> - 您可以使用系统提供的AI服务，计划将自动保存到您的账户';
                loggedInConfig.style.display = 'block';
                guestConfig.style.display = 'none';
            } else {
                // 未登录（游客）
                loginStatusAlert.className = 'alert alert-warning mb-4';
                loginStatusText.innerHTML = '<strong>游客模式</strong> - 请配置您自己的API来体验，或 <a href="login.html">登录</a> 使用系统服务';
                loggedInConfig.style.display = 'none';
                guestConfig.style.display = 'block';
            }
            
            loginStatusAlert.style.display = 'block';
        }
        
        document.getElementById('createPlanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> AI正在生成计划...';
            generateBtn.disabled = true;
            
            const data = {
                goal: document.getElementById('goal').value,
                level: document.getElementById('level').value,
                dailyHours: parseFloat(document.getElementById('dailyHours').value),
                totalDays: parseInt(document.getElementById('totalDays').value),
                title: document.getElementById('title').value || null
            };
            
            let endpoint = '/plan/generate';
            
            if (isLoggedIn()) {
                // 登录用户
                data.modelName = document.getElementById('modelSelect').value;
            } else {
                // 游客
                endpoint = '/plan/generate/guest';
                data.customApiUrl = document.getElementById('customApiUrl').value;
                data.customApiKey = document.getElementById('customApiKey').value;
                data.modelName = document.getElementById('customModel').value;
                
                // 验证游客必填项
                if (!data.customApiUrl || !data.customApiKey || !data.modelName) {
                    showToast('请填写完整的API配置信息', 'error');
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                    return;
                }
            }
            
            try {
                const result = await apiRequest(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                if (result && result.code === 200) {
                    showToast('计划生成成功！', 'success');
                    document.getElementById('resultArea').style.display = 'block';
                    
                    if (isLoggedIn()) {
                        // 登录用户显示保存的计划
                        document.getElementById('planPreview').innerHTML = `
                            <div class="alert alert-success">
                                <strong>${result.data.title || result.data.goal}</strong><br>
                                <small>开始日期：${result.data.startDate || formatDate(new Date())} | 计划天数：${result.data.totalDays || data.totalDays}天</small>
                            </div>
                        `;
                        document.getElementById('resultActions').innerHTML = `
                            <a href="my-plans.html" class="btn btn-success">
                                <i class="bi bi-list-check"></i> 查看我的计划
                            </a>
                        `;
                    } else {
                        // 游客显示预览
                        const planData = result.data;
                        let previewHtml = `
                            <div class="alert alert-info">
                                <strong>${planData.title || '学习计划'}</strong><br>
                                <small>${planData.summary || ''}</small>
                            </div>
                            <div class="alert alert-warning">
                                <i class="bi bi-info-circle"></i> 这是游客预览，计划未保存。<a href="register.html">注册账号</a>可保存您的学习计划！
                            </div>
                        `;
                        
                        // 显示前3天计划预览
                        if (planData.dailyPlans && planData.dailyPlans.length > 0) {
                            previewHtml += '<h6>计划预览（前3天）：</h6><ul class="list-group">';
                            for (let i = 0; i < Math.min(3, planData.dailyPlans.length); i++) {
                                const day = planData.dailyPlans[i];
                                previewHtml += `
                                    <li class="list-group-item">
                                        <strong>第${day.day}天：</strong>${day.content.substring(0, 100)}...
                                    </li>
                                `;
                            }
                            previewHtml += '</ul>';
                        }
                        
                        document.getElementById('planPreview').innerHTML = previewHtml;
                        document.getElementById('resultActions').innerHTML = `
                            <a href="register.html" class="btn btn-primary">
                                <i class="bi bi-person-plus"></i> 注册账号保存计划
                            </a>
                            <a href="login.html" class="btn btn-outline-primary">
                                <i class="bi bi-box-arrow-in-right"></i> 已有账号？登录
                            </a>
                        `;
                    }
                } else {
                    showToast(result?.message || '生成失败，请重试', 'error');
                }
            } catch (error) {
                console.error('请求错误:', error);
                showToast('网络错误，请稍后重试', 'error');
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
